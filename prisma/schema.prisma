generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// (أعلى ملف schema.prisma)

enum TransactionType {
  feed
  handover
}

enum TransactionStatus {
  pending
  accepted
  rejected
}

model contracts {
  id                              Int       @id @default(autoincrement())
  contract_number                 Int
  car_model                       String    @db.VarChar(255)
  plate_number                    String    @db.VarChar(255)
  operation_type                  String    @db.VarChar(50)
  employee_name                   String    @db.VarChar(100)
  branch_name                     String    @db.VarChar(100)
  meter                           String?   @db.VarChar(512)
  right_doors                     String?   @db.VarChar(512)
  front_right_fender              String?   @db.VarChar(512)
  rear_right_fender               String?   @db.VarChar(512)
  rear_bumper_with_lights         String?   @db.VarChar(512)
  trunk_lid                       String?   @db.VarChar(512)
  roof                            String?   @db.VarChar(512)
  rear_left_fender                String?   @db.VarChar(512)
  left_doors                      String?   @db.VarChar(512)
  front_left_fender               String?   @db.VarChar(512)
  front_bumper                    String?   @db.VarChar(512)
  hoode                           String?   @db.VarChar(512)
  front_windshield                String?   @db.VarChar(512)
  trunk_contents                  String?   @db.VarChar(512)
  fire_extinguisher               String?   @db.VarChar(512)
  front_right_seat                String?   @db.VarChar(512)
  front_left_seat                 String?   @db.VarChar(512)
  rear_seat_with_front_seat_backs String?   @db.VarChar(512)
  other_images                    String?   @db.VarChar(512)
  client_id                       String    @db.VarChar(45)
  meter_reading                   String?   @db.VarChar(255)
  created_at                      DateTime? @default(now()) @db.DateTime(0)
  updated_at                      DateTime? @updatedAt @db.DateTime(0)
  client_name                     String    @db.VarChar(255)
  signature_url                   String?   @db.VarChar(512)
}

model users {
  Name          String
  id            Int             @id @default(autoincrement())
  EmID          Int             @unique
  password      String
  role          String
  branch        String
  created_at    DateTime?       @default(now()) @db.DateTime(0)
  updated_at    DateTime?       @default(now()) @db.DateTime(0)
  last_login    DateTime?       @db.DateTime(0)
  is_active     Boolean?        @default(true)
  tokens        tokens[]
  user_sessions user_sessions[]

  sent_transactions     cash_transactions[] @relation("SentTransactions")
  received_transactions cash_transactions[] @relation("ReceivedTransactions")

  @@index([branch], map: "idx_users_branch")
  @@index([is_active], map: "idx_users_is_active")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model plateslist {
  id         Int     @id @default(autoincrement())
  plate_name String? @db.VarChar(512)
  cars       cars[]
}

model cars {
  id       Int         @id @default(autoincrement())
  car_name String      @db.VarChar(512)
  plate_id Int?
  plate    plateslist? @relation(fields: [plate_id], references: [id], onDelete: Restrict, map: "fk_cars_plateslist")

  @@index([plate_id], map: "fk_cars_plateslist")
}

model branches {
  id          Int    @id @default(autoincrement())
  branch_name String @db.VarChar(512)
  current_cash Decimal @default(0) @db.Decimal(10, 2)
  is_frozen   Boolean @default(false)
  @@map("branches")
}

model CarsDetails {
  owner_name           String? @db.VarChar(512)
  specification_policy String? @db.VarChar(512)
  Ref                  Int?
  make_no              Int?
  manufacturer         String? @db.VarChar(512)
  model_no             Int?
  model                String? @db.VarChar(512)
  type_no              String? @db.VarChar(512)
  Type                 String? @db.VarChar(512)
  seats                Int?
  manufacturing_year   Int?
  plate                String? @db.VarChar(512)
  sequance             Int?
  chassis              String? @db.VarChar(512)
  excess               Int?
  color                String? @db.VarChar(512)
  sum_insured          Int?
  premium              Int?
  id                   Int     @id @default(autoincrement())

  @@index([plate], map: "idx_plate")
  @@map("cars_details")
}

model tokens {
  id         Int         @id @default(autoincrement())
  user_id    Int
  token      String      @unique @db.VarChar(255)
  type       tokens_type
  expires_at DateTime    @db.DateTime(0)
  created_at DateTime?   @default(now()) @db.DateTime(0)
  is_active  Boolean?    @default(true)
  users      users       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, is_active, expires_at], map: "idx_tokens_active_user")
  @@index([expires_at])
  @@index([token])
  @@index([user_id])
  @@map("tokens")
}

model user_sessions {
  id            Int       @id @default(autoincrement())
  user_id       Int
  refresh_token String    @db.VarChar(255)
  device_info   String?   @db.Text
  ip_address    String?   @db.VarChar(45)
  last_activity DateTime? @default(now()) @db.DateTime(0)
  created_at    DateTime? @default(now()) @db.DateTime(0)
  users         users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, last_activity], map: "idx_sessions_user_activity")
  @@index([refresh_token])
  @@index([user_id])
  @@map("user_sessions")
}

enum tokens_type {
  access
  refresh
}

model cash_transactions {
  id Int @id @default(autoincrement())

  // حقل الفرع (كما هو في جدول users)
  branch_name String @db.VarChar(255)

  // استخدام الـ ENUMs التي عرفناها
  type   TransactionType
  status TransactionStatus @default(pending)

  amount           Decimal @db.Decimal(10, 2)
  notes            String? @db.Text
  rejection_reason String? @db.Text

  // الربط بجدول الموظفين
  sender_employee_id   Int
  receiver_employee_id Int?

  sender_employee   users  @relation("SentTransactions", fields: [sender_employee_id], references: [id])
  receiver_employee users? @relation("ReceivedTransactions", fields: [receiver_employee_id], references: [id])

  created_at DateTime @default(now()) @db.Timestamp(0) // افترضت 0 بناءً على جداولك القديمة
  processed_at       DateTime? @db.Timestamp(0)
  requires_review    Boolean   @default(false)

  // العلاقة العكسية مع المصروفات
  expenses expenses[]

  @@index([branch_name], map: "idx_branch_name")
  @@index([sender_employee_id], map: "idx_sender_id")
  @@index([receiver_employee_id], map: "idx_receiver_id")
  @@index([status], map: "idx_status")
  @@map("cash_transactions")
}

model expenses {
  id Int @id @default(autoincrement())

  // الربط بالجدول الرئيسي
  transaction_id Int
  transaction    cash_transactions @relation(fields: [transaction_id], references: [id], onDelete: Cascade)

  // بيانات المصروف
  contract_number String? @db.VarChar(100)
  notes           String  @db.VarChar(255)
  amount          Decimal @db.Decimal(10, 2)

  @@index([transaction_id], map: "idx_transaction_id")
  @@map("expenses")
}

model wix_bookings {
  id             Int       @id @default(autoincrement())
  client_name    String
  client_phone   String    @db.VarChar(25)
  client_age     Int?
  car_category   String?   @db.VarChar(255)
  booking_days   Int?
  pickup_date    DateTime? @db.Date
  pickup_branch  String?   @db.VarChar(255)
  status         String    @default("pending") @db.VarChar(50) // (العمود الذي أضفته)
  follow_up_note String?   @db.Text                     // (العمود الذي أضفته)
  created_at     DateTime  @default(now()) @db.Timestamp(0)
  updated_at     DateTime? @updatedAt @db.Timestamp(0)

  @@map("wix_bookings") // للربط مع اسم الجدول في MySQL
}
